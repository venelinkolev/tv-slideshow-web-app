<!-- TV Error State Container -->
<div [class]="errorClasses().join(' ')" [attr.aria-live]="isVisible() ? 'polite' : null"
    [attr.aria-hidden]="!isVisible()">

    <!-- Main Error Display -->
    @if (isVisible()) {
    <div class="error-state__overlay">
        <div class="error-state__container">

            <!-- Error Header -->
            <div class="error-state__header">
                <div class="error-state__icon" [attr.aria-label]="'–ì—Ä–µ—à–∫–∞ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ' + errorCategory()">
                    {{ errorIcon() }}
                </div>
                <h2 class="error-state__title">
                    @switch (errorCategory()) {
                    @case ('network') { –ü—Ä–æ–±–ª–µ–º —Å –≤—Ä—ä–∑–∫–∞—Ç–∞ }
                    @case ('timeout') { –ò–∑—Ç–µ—á–µ –≤—Ä–µ–º–µ—Ç–æ }
                    @case ('server') { –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞ –≥—Ä–µ—à–∫–∞ }
                    @case ('not_found') { –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–æ }
                    @case ('auth') { –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –æ—Ç–æ—Ä–∏–∑–∞—Ü–∏—è }
                    @case ('forbidden') { –ù—è–º–∞ –ø—Ä–∞–≤–∞ }
                    @case ('validation') { –ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏ }
                    @default { –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ }
                    }
                </h2>
            </div>

            <!-- Error Message -->
            <div class="error-state__message">
                <p class="error-state__description">
                    {{ friendlyErrorMessage() }}
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="error-state__actions">

                <!-- Retry Button -->
                @if (shouldShowRetryButton()) {
                <button class="error-state__button error-state__button--primary"
                    [class.error-state__button--loading]="isRetrying()" [disabled]="isRetrying()"
                    (click)="onRetryClick()" [attr.aria-label]="actionButtonText() + ' - –æ—Å–Ω–æ–≤–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ'">

                    @if (isRetrying()) {
                    <span class="error-state__loading-spinner" aria-hidden="true"></span>
                    }

                    <span class="error-state__button-text">
                        {{ actionButtonText() }}
                    </span>
                </button>
                }

                <!-- Dismiss Button -->
                <button class="error-state__button error-state__button--secondary" (click)="onDismissClick()"
                    [attr.aria-label]="'–ó–∞—Ç–≤–æ—Ä–∏ –≥—Ä–µ—à–∫–∞—Ç–∞'">
                    –ó–∞—Ç–≤–æ—Ä–∏
                </button>

                <!-- Details Toggle Button -->
                @if (showDetails() || originalError()) {
                <button class="error-state__button error-state__button--link" (click)="onToggleDetails()"
                    [attr.aria-expanded]="showErrorDetails()"
                    [attr.aria-label]="showErrorDetails() ? '–°–∫—Ä–∏–π –¥–µ—Ç–∞–π–ª–∏—Ç–µ' : '–ü–æ–∫–∞–∂–∏ –¥–µ—Ç–∞–π–ª–∏—Ç–µ'">

                    <span class="error-state__details-icon" [class.rotated]="showErrorDetails()">
                        ‚ñº
                    </span>

                    {{ showErrorDetails() ? '–°–∫—Ä–∏–π –¥–µ—Ç–∞–π–ª–∏—Ç–µ' : '–ü–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏' }}
                </button>
                }
            </div>

            <!-- Error Details Section (Collapsible) -->
            @if (showErrorDetails()) {
            <div class="error-state__details" role="region" aria-label="–î–µ—Ç–∞–π–ª–∏ –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞">

                <!-- Technical Details -->
                <div class="error-state__technical-info">
                    <h3 class="error-state__details-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

                    <div class="error-state__code-block">
                        <pre class="error-state__code">{{ getDetailedErrorInfo() }}</pre>
                    </div>

                    <!-- Error Context -->
                    @if (originalError()?.context) {
                    <div class="error-state__context">
                        <h4 class="error-state__context-title">–ö–æ–Ω—Ç–µ–∫—Å—Ç:</h4>
                        <div class="error-state__context-data">
                            {{ originalError()!.context | json }}
                        </div>
                    </div>
                    }

                    <!-- Retry Strategy Info -->
                    @if (originalError()?.retryStrategy) {
                    <div class="error-state__retry-info">
                        <h4 class="error-state__retry-title">–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω –æ–ø–∏—Ç:</h4>
                        <ul class="error-state__retry-details">
                            <li>–ú–æ–∂–µ –¥–∞ —Å–µ –ø–æ–≤—Ç–æ—Ä–∏: {{ originalError()!.retryStrategy!.canRetry ? '–î–∞' : '–ù–µ' }}</li>
                            @if (originalError()!.retryStrategy!.retryDelay) {
                            <li>–ó–∞–±–∞–≤—è–Ω–µ: {{ originalError()!.retryStrategy!.retryDelay }}–º—Å</li>
                            }
                            @if (originalError()!.retryStrategy!.maxRetries) {
                            <li>–ú–∞–∫—Å–∏–º—É–º –æ–ø–∏—Ç–∏: {{ originalError()!.retryStrategy!.maxRetries }}</li>
                            }
                        </ul>
                    </div>
                    }
                </div>

                <!-- Error Reporting Section -->
                <div class="error-state__reporting">
                    <h3 class="error-state__reporting-title">–î–æ–∫–ª–∞–¥–≤–∞–π –ø—Ä–æ–±–ª–µ–º–∞</h3>
                    <p class="error-state__reporting-description">
                        –ú–æ–∂–µ—Ç–µ –¥–∞ –Ω–∏ –ø–æ–º–æ–≥–Ω–µ—Ç–µ –¥–∞ –ø–æ–¥–æ–±—Ä–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ, –∫–∞—Ç–æ –æ–ø–∏—à–µ—Ç–µ –∫–∞–∫–≤–æ –ø—Ä–∞–≤–∏—Ö—Ç–µ –∫–æ–≥–∞—Ç–æ –≤—ä–∑–Ω–∏–∫–Ω–∞
                        –≥—Ä–µ—à–∫–∞—Ç–∞.
                    </p>

                    <div class="error-state__comment-section">
                        <label for="user-comment" class="error-state__comment-label">
                            –ö–æ–º–µ–Ω—Ç–∞—Ä (–ø–æ –∏–∑–±–æ—Ä):
                        </label>
                        <textarea id="user-comment" class="error-state__comment-input"
                            placeholder="–û–ø–∏—à–µ—Ç–µ –∫–∞–∫–≤–æ –ø—Ä–∞–≤–∏—Ö—Ç–µ –∫–æ–≥–∞—Ç–æ –≤—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞—Ç–∞..." rows="3"
                            [value]="userComment()" (input)="onUserCommentChange($any($event.target).value)"
                            maxlength="500">
                </textarea>
                        <div class="error-state__comment-counter">
                            {{ userComment().length }}/500
                        </div>
                    </div>

                    <button class="error-state__button error-state__button--report" (click)="onReportError()"
                        [attr.aria-label]="'–ò–∑–ø—Ä–∞—Ç–∏ –¥–æ–∫–ª–∞–¥ –∑–∞ –≥—Ä–µ—à–∫–∞—Ç–∞'">
                        üìß –ò–∑–ø—Ä–∞—Ç–∏ –¥–æ–∫–ª–∞–¥
                    </button>
                </div>
            </div>
            }

        </div>

        <!-- Background Overlay -->
        <div class="error-state__backdrop" (click)="onDismissClick()" aria-hidden="true">
        </div>
    </div>
    }

</div>

<!-- Accessibility Support -->
@if (isVisible()) {
<!-- Screen Reader Announcement -->
<div class="sr-only" aria-live="assertive">
    –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: {{ friendlyErrorMessage() }}.
    @if (shouldShowRetryButton()) {
    –ú–æ–∂–µ—Ç–µ –¥–∞ –æ–ø–∏—Ç–∞—Ç–µ –æ—Ç–Ω–æ–≤–æ –∏–ª–∏ –¥–∞ –∑–∞—Ç–≤–æ—Ä–∏—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ.
    } @else {
    –ú–æ–ª—è, –∑–∞—Ç–≤–æ—Ä–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –∑–∞ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ.
    }
</div>
}